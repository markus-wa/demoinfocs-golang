name: Update Protobufs
on:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - protobuf-bot
jobs:
  protobuf:
    name: Update Protobufs
    runs-on: ubuntu-latest
    env:
      GameTracking_dir: /tmp/GameTracking-CSGO
    steps:
      - uses: actions/checkout@v1
      - name: Download latest Protobufs
        run: |
          git clone https://github.com/SteamDatabase/GameTracking-CSGO.git $GameTracking_dir
          cp $GameTracking_dir/Protobufs/{cstrike15_*.proto,engine_gcmessages.proto,netmessages.proto,steammessages.proto} pkg/demoinfocs/msg/proto
      - name: Commit changes
        run: |
          if [[ ! `git status --porcelain` ]]; then
              echo '::set-env name=PROTOBUFS_CHANGED::false'
              exit 0
          else
              echo '::set-env name=PROTOBUFS_CHANGED::true'
          fi

          commit_sha=$(pushd $GameTracking_dir > /dev/null && git rev-parse HEAD && popd > /dev/null)
          branch=update-protobufs/$commit_sha
          echo "::set-env name=BRANCH::$branch"
          git checkout -b $branch
          git add .
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "protobuf: updated to $commit_sha\n\nsee https://github.com/SteamDatabase/GameTracking-CSGO"
      - name: Push changes to new branch
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH }}
          base: master
          force: true
      - name: Create Pull Request
        id: pr
        if: env.PROTOBUFS_CHANGED == 'true'
        uses: peter-evans/create-pull-request@v2
      - name: Print PR outputs
        run: |
          echo "Pull Request Number - ${{ env.PULL_REQUEST_NUMBER }}"
          echo "Pull Request Number - ${{ steps.pr.outputs.pull-request-number }}"
