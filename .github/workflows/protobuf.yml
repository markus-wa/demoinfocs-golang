name: Update Protobufs
on:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - protobuf-bot
jobs:
  protobuf:
    name: Update Protobufs
    runs-on: ubuntu-latest
    env:
      GameTracking_dir: /tmp/GameTracking-CSGO
    steps:
      - uses: actions/checkout@v1
      - name: Download latest Protobufs
        run: |
          git clone https://github.com/SteamDatabase/GameTracking-CSGO.git $GameTracking_dir
          cp $GameTracking_dir/Protobufs/{cstrike15_*.proto,engine_gcmessages.proto,netmessages.proto,steammessages.proto} pkg/demoinfocs/msg/proto
      - name: Create Branch
        run: |
          if [[ ! `git status --porcelain` ]]; then
              echo '::set-env name=PROTOBUFS_CHANGED::false'
              exit 0
          else
              echo '::set-env name=PROTOBUFS_CHANGED::true'
          fi

          commit_sha=$(pushd $GameTracking_dir > /dev/null && git rev-parse HEAD && popd > /dev/null)
          branch=update-protobufs/$commit_sha
          git checkout -b $branch
          git add .
          git config --global user.email "m.walther97@gmail.com"
          git config --global user.name "Markus Walther"
          git commit -m "protobuf: updated to $commit_sha\n\nsee https://github.com/SteamDatabase/GameTracking-CSGO"
          git push -u origin $branch
      - name: Create Pull Request
        if: env.PROTOBUFS_CHANGED == 'true'
        uses: peter-evans/create-pull-request@v2
